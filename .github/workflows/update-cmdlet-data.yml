name: Update cmdlet data

on:
  schedule:
    - cron: "30 6 * * *"
  workflow_dispatch:

concurrency:
  group: update-cmdlet-data
  cancel-in-progress: true

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    outputs:
      changes_detected: ${{ steps.auto-commit.outputs.changes_detected }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone Microsoft Entra docs
        run: |
          rm -rf docs
          git clone --depth 1 --filter=blob:none --sparse \
            https://github.com/MicrosoftDocs/entra-powershell-docs.git docs
          cd docs && git sparse-checkout set docs/reference/v1.0 docs/reference/beta
          rm -rf .git

      - name: Parse documentation
        run: python3 scripts/parse_docs.py docs/docs/reference

      - name: Clean up cloned docs
        run: rm -rf docs

      - name: Commit updated data
        id: auto-commit
        run: |
          git add public/data/**
          if git diff --cached --quiet; then
            echo "changes_detected=false" >> "$GITHUB_OUTPUT"
          else
            git -c user.name="github-actions[bot]" \
                -c user.email="41898282+github-actions[bot]@users.noreply.github.com" \
                commit -m "chore: update cmdlet metadata"
            echo "changes_detected=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Push changes
        if: steps.auto-commit.outputs.changes_detected == 'true'
        run: git push

  deploy:
    needs: update-data
    if: needs.update-data.outputs.changes_detected == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
